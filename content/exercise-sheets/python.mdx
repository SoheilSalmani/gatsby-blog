---
title: Python
relatedResources:
  - https://cjolowicz.github.io/posts/hypermodern-python-01-setup/
tags: []
---

1. Install pyenv and install Python 3.9.7 and 3.8.12 using it. Create a GitHub
   repository and pull it, then make the Python installations available inside
   the repository.

   <Solution>

   Install pyenv.

   ```shell
   pyenv install 3.9.7
   pyenv install 3.8.12
   ```

   ```shell
   git init
   pyenv local 3.9.7 3.8.12
   ```

   </Solution>

2. Install Poetry and initialize your Python project using Poetry (without
   interaction).

   <Solution>

   Install Poetry and source `~/.poetry/env` in your current shell.

   ```shell
   poetry init --no-interaction
   ```

   </Solution>

3. Add some metadata to the package.

   <Solution>

   ```toml fp=pyproject.toml
   [tool.poetry]
   ...
   description = "The Wikipedia CLI"
   license = "MIT"
   readme = "README.md"
   homepage = "https://github.com/SoheilSalmani/wikipedia-cli"
   repository = "https://github.com/<your-username>/wikipedia-cli"
   keywords = ["wikipedia", "cli"]
   ```

   </Solution>

4. Update the `pyproject.toml` to support Python 3.8.

   <Solution>

   ```toml fp=pyproject.toml hl=2
   [tool.poetry.dependencies]
   python = "^3.8"
   ```

   </Solution>

5. Create a `wikipedia_cli` package in `src/` and specify a version of `0.1.0`.

   <Solution>

   ```tree
   .
   ├── pyproject.toml
   └── src
       └── wikipedia_cli
           └── __init__.py
   ```

   ```python nu fp=src/wikipedia_cli/__init__.py
   __version__ = "0.1.0"
   ```

   </Solution>

6. Create a virtual environment dedicated to your project, and install your
   package into it.

   <Solution>

   ```shell
   poetry install
   poetry run python
   ```

   ```python
   >>> import wikipedia_cli
   >>> wikipedia_cli.__version__
   ```

   </Solution>

7. Build a `console` module definined a command-line application which prints a
   random Wikipedia article. Code related to the Wikipedia API should be written
   in a `wikipedia` module. Register the executable in `pyproject.toml`. Use
   this endpoint: `https://en.wikipedia.org/api/rest_v1/page/random/summary`.

   <Solution>

   ```shell
   poetry add click requests
   ```

   ```python nu fp=src/wikipedia_cli/console.py
   import textwrap

   import click
   import requests

   from . import __version__, wikipedia

   @click.command()
   @click.option(
       "--language",
       "-l",
       default="en",
       help="Language edition of Wikipedia",
       metavar="LANG",
       show_default=True,
   )
   @click.version_option(version=__version__)
   def main(language):
       """The hypermodern Python project."""
       try:
           data = wikipedia.random_page(language=language)
       except requests.RequestException as error:
           raise click.ClickException(str(error)) from error

       title = data["title"]
       extract = data["extract"]

       click.secho(title, fg="green")
       click.echo(textwrap.fill(extract))
   ```

   ```python nu fp=src/wikipedia_cli/wikipedia.py
   import requests

   API_URL = "https://{language}.wikipedia.org/api/rest_v1/page/random/summary"

   def random_page(language="en"):
       url = API_URL.format(language=language)
       with requests.get(url) as response:
           response.raise_for_status()
           return response.json()
   ```

   ```toml fp=pyproject.toml
   [tool.poetry.scripts]
   wikipedia-cli = "wikipedia_cli.console:main"
   ```

   ```shell
   poetry install
   ```

   </Solution>

8. Upgrade a dependency package to a new minor or patch release.

   <Solution>

   ```shell
   poetry update click
   ```

   </Solution>

9. Upgrade a dependency to a new major release.

   <Solution>

   ```shell
   poetry add click^7.0
   ```

   </Solution>

10. Add a `.gitignore` file.

    <Solution>

    ```gitignore nu
    /.python-version
    __pycache__/
    ```

    </Solution>

11. Write several unit and e2e tests and configure Coverage.py.

    <Solution>

    ```shell
    poetry add --dev pytest coverage[toml] pytest-cov pytest-mock
    ```

    ```toml fp=pyproject.toml
    [tool.coverage.paths]
    source = ["src", "*/site-packages"]

    [tool.coverage.run]
    branch = true
    source = ["wikipedia_cli"]

    [tool.coverage.report]
    show_missing = true
    fail_under = 100
    ```

    ```python nu fp=conftest.py
    def pytest_configure(config):
        config.addinivalue_line("markers", "unit: mark as unit test.")
        config.addinivalue_line("markers", "e2e: mark as end-to-end test.")
    ```

    ```python nu fp=tests/test_console.py
    import pytest
    import requests

    from wikipedia_cli import console

    @pytest.fixture
    def mock_wikipedia_get_random(mocker):
        mock = mocker.patch("wikipedia_cli.wikipedia.get_random")
        mock.return_value = {
            "title": "Title of the article",
            "extract": "Extract of the article."
        }
        return mock

    @pytest.mark.unit
    def test_main_returns_0(cli_runner, mock_wikipedia_get_random):
        result = cli_runner.invoke(console.main)
        assert result.exit_code == 0

    @pytest.mark.unit
    def test_main_prints_title(cli_runner, mock_wikipedia_get_random):
        result = cli_runner.invoke(console.main)
        assert "Title of the article" in result.output

    @pytest.mark.unit
    def test_main_uses_specified_lang(cli_runner, mock_wikipedia_get_random):
        cli_runner.invoke(console.main, ["--lang=pl"])
        mock_wikipedia_get_random.assert_called_with(lang="pl")

    @pytest.mark.unit
    def test_main_returns_1_on_request_exception(cli_runner, mock_wikipedia_get_random):
        mock_wikipedia_get_random.side_effect = requests.RequestException
        result = cli_runner.invoke(console.main)
        assert "Error" in result.output

    @pytest.mark.e2e
    def test_main_returns_0_in_production(cli_runner):
        result = cli_runner.invoke(console.main)
        assert result.exit_code == 0
    ```

    ```python nu fp=tests/test_wikipedia.py
    import pytest

    from wikipedia_cli import wikipedia

    @pytest.fixture
    def mock_requests_get(mocker):
       return mocker.patch("requests.get")

    def test_get_random_uses_en_wikipedia_domain_by_default(mock_requests_get):
        wikipedia.get_random()
        args, _ = mock_requests_get.call_args
        assert "en.wikipedia.org" in args[0]

    def test_get_random_uses_specified_wikipedia_domain(mock_requests_get):
        wikipedia.get_random(lang="de")
        args, _ = mock_requests_get.call_args
        assert "de.wikipedia.org" in args[0]
    ```

    </Solution>

12. Configure Nox and add a `tests` session to run unit tests for each Python
    version.

    <Solution>

    ```shell
    pip install nox
    ```

    ```python nu fp=noxfile.py
    import contextlib
    import tempfile

    import nox

    package = "wikipedia_cli"

    class Poetry:
        def __init__(self, session):
            self.session = session

        @contextlib.contextmanager
        def export(self, *args):
            with tempfile.NamedTemporaryFile() as requirements:
                self.session.run(
                    "poetry",
                    "export",
                    *args,
                    "--format=requirements.txt",
                    f"--output={requirements.name}",
                    "--without-hashes",
                    external=True,
                )
                yield requirements.name

        def version(self):
            output = self.session.run(
                "poetry", "version", external=True, silent=True
            )
            return output.split()[1]

        def build(self, *args):
            self.session.run("poetry", "build", *args, external=True, silent=True)

    def install_package(session):
        poetry = Poetry(session)

        with poetry.export() as requirements:
            session.install(f"--requirement={requirements}")

        poetry.build("--format=wheel")

        version = poetry.version()
        session.install(
            "--no-deps", "--force-reinstall", f"dist/{package}-{version}-py3-none-any.whl"
        )

    def install(session, *args):
        poetry = Poetry(session)
        with poetry.export("--dev") as requirements:
            session.install(f"--constraint={requirements}", *args)

    @nox.session(python=["3.9", "3.8"])
    def tests(session):
        args = session.posargs or ["--cov", "-m", "not e2e"]
        install_package(session)
        install(session, "coverage[toml]", "pytest", "pytest-cov", "pytest-mock")
        session.run("pytest", *args)
    ```

    ```shell
    nox -rs tests-3.9 -- -m e2e
    ```

    </Solution>

13. Update the `.gitignore` file.

    <Solution>

    ```gitignore nu hl=3..6
    /.python-version
    __pycache__/
    /.coverage
    /dist/
    .pytest_cache/
    /.nox/
    ```

    </Solution>

14. Configure Black, Flake8 and Safety in the project.

    <Solution>

    ```shell
    poetry add --dev \
        black \
        flake8 \
        flake8-bandit \
        flake8-black \
        flake8-bugbear \
        flake8-import-order \
        safety
    ```

    ```toml nu fp=flake8
    [flake8]
    select = B,B9,BLK,C,E,F,I,S,W
    ignore = E203, E501, W503
    max-complexity = 10
    max-line-length = 80
    application-import-names = wikipedia_cli,tests
    import-order-style = google
    per-file-ignores = tests/*:S101
    ```

    ```python fp=noxfile.py
    ...

    locations = "src", "tests", "noxfile.py"
    nox.options.sessions = "lint", "safety", "tests"

    ...

    @nox.session(python=["3.9", "3.8"])
    def lint(session):
        args = session.posargs or locations
        install(
            session,
            "flake8",
            "flake8-bandit",
            "flake8-black",
            "flake8-bugbear",
            "flake8-import-order",
        )
        session.run("flake8", *args)

    @nox.session(python=["3.9"])
    def safety(session):
        poetry = Poetry(session)
        with poetry.export("--dev") as requirements:
            install(session, "safety")
            session.run("safety", "check", f"--file={requirements}", "--bare")

    ...

    @nox.session(python=["3.9"])
    def black(session):
        args = session.posargs or locations
        install(session, "black")
        session.run("black", *args)
    ```

    </Solution>

15. Install an insecure package, and check that Safety detect it.

    <Solution>

    ```shell
    poetry add insecure-package
    nox -rs safety
    poetry remove insecure-package
    ```

    </Solution>

16. Configure pre-commit to run Black and Flake8 during a commit. Apply checks
    to all files.

    <Solution>

    ```shell
    pip install pre-commit
    ```

    ```yaml nu fp=.pre-commit-config.yaml
    repos:
      - repo: https://github.com/pre-commit/pre-commit-hooks
        rev: v4.0.1
        hooks:
          - id: trailing-whitespace
          - id: end-of-file-fixer
          - id: check-yaml
      - repo: local
        hooks:
          - id: black
            name: black
            entry: poetry run black
            language: system
            types: [python]
          - id: flake8
            name: flake8
            entry: poetry run flake8
            language: system
            types: [python]
    ```

    ```shell
    pre-commit install
    ```

    ```shell
    pre-commit run --all-files
    ```

    </Solution>

17. Use Desert and Marshmallow to validate data fetched from the Wikipedia API.

    <Solution>

    ```shell
    poetry add marshmallow desert
    ```

    ```python fp=src/wikipedia_cli/wikipedia.py
    import desert
    import marshmallow

    ...

    @dataclass
    class Page:
        title: str
        extract: str

    page_schema = desert.schema(Page, meta={"unknown": marshmallow.EXCLUDE})

    def get_random(lang="en"):
        url = API_URL.format(lang=lang)
        with requests.get(url) as response:
            response.raise_for_status()
            data = response.json()
            return page_schema.load(data)
    ```

    ```python fp=src/wikipedia_cli/console.py
    import marshmallow

    ...

    def main(lang):
        try:
            page = wikipedia.get_random(lang=lang)
        except (requests.RequestException, marshmallow.ValidationError) as error:
            raise click.ClickException(str(error)) from error

        click.secho(page.title, fg="green")
        click.echo(textwrap.fill(page.extract))
    ```

    ```python fp=tests/test_wikipedia.py
    def test_random_page_returns_page(mock_requests_get: Mock) -> None:
        page = wikipedia.get_random()
        assert isinstance(page, wikipedia.Page)
    ```

    ```python fp=tests/test_console.py
    from wikipedia_cli.wikipedia import page_schema

    @pytest.fixture
    def mock_wikipedia_get_random(mocker):
        mock = mocker.patch("wikipedia_cli.wikipedia.get_random")
        mock.return_value = page_schema.load(
            {
                "title": "Title of the article",
                "extract": "Extract of the article.",
            }
        )
        return mock
    ```

    </Solution>

18. Configure Mypy, Pytype and Typeguard in the project.

    <Solution>

    ```shell
    poetry add --dev mypy pytype typeguard
    ```

    ```python fp=noxfile.py
    nox.options.sessions = "lint", "mypy", "pytype", "safety", "tests"

    @nox.session(python=["3.9", "3.8"])
    def mypy(session):
        args = session.posargs or locations
        install_package(session)
        install(session, "mypy")
        session.run("mypy", *args)

    @nox.session(python=["3.9", "3.8"])
    def pytype(session):
        args = session.posargs or ["--disable=import-error", *locations]
        install_package(session)
        install(session, "pytype")
        session.run("pytype", *args)

    @nox.session(python=["3.9", "3.8"])
    def typeguard(session):
        args = session.posargs or ["-m", "not e2e"]
        install_package(session)
        install(session, "pytest", "pytest-mock", "typeguard")
        session.run("pytest", f"--typeguard-packages={package}", *args)
    ```

    ```ini nu fp=mypy.ini
    [mypy]

    [mypy-desert,marshmallow,nox.*,pytest,pytest_mock,_pytest.*]
    ignore_missing_imports = True
    ```

    </Solution>

19. Add type annotations in the codebase, and check them using a Flake8 plugin.

    <Solution>

    ```shell
    poetry add --dev flake8-annotations
    ```

    ```ini fp=.flake8
    [flake8]
    select = ANN,B,B9,BLK,C,E,F,I,S,W
    ignore = ANN101,E203,E501,W503
    ```

    ```python fp=src/wikipedia_cli/wikipedia.py
    API_URL: str = "https://{lang}.wikipedia.org/api/rest_v1/page/random/summary"

    def get_random(lang: str = "en") -> Page: ...
    ```

    ```python fp=src/wikipedia_cli/console.py
    def main(lang: str) -> None: ...
    ```

    ```python fp=noxfile.py
    from typing import Iterator

    from nox.sessions import Session

    class Poetry:
        def __init__(self, session: Session) -> None: ...
        def export(self, *args: str) -> Iterator[str]: ...
        def version(self) -> str: ...
        def build(self, *args: str) -> None: ...

    def install_package(session: Session) -> None: ...

    def install(session: Session, *args: str) -> None: ...

    def lint(session: Session) -> None: ...

    def mypy(session: Session) -> None: ...

    def pytype(session: Session) -> None: ...

    def safety(session: Session) -> None: ...

    def tests(session: Session) -> None: ...

    def black(session: Session) -> None: ...

    def typeguard(session: Session) -> None: ...
    ```

    ```python fp=tests/test_wikipedia.py
    from unittest.mock import Mock

    from pytest_mock import MockFixture

    def mock_requests_get(mocker: MockFixture) -> Mock: ...

    def test_get_random_uses_en_wikipedia_domain_by_default(mock_requests_get: Mock) -> None: ...

    def test_get_random_uses_specified_wikipedia_domain(mock_requests_get: Mock) -> None:

    def test_random_page_returns_page(mock_requests_get: Mock) -> None: ...
    ```

    ```python fp=tests/test_console.py
    from unittest.mock import Mock

    from pytest_mock import MockFixture

    def cli_runner() -> CliRunner: ...

    def mock_wikipedia_get_random(mocker: MockFixture) -> Mock: ...

    def test_main_returns_0(cli_runner: CliRunner, mock_wikipedia_get_random: Mock) -> None: ...

    def test_main_prints_title(cli_runner: CliRunner, mock_wikipedia_get_random: Mock) -> None: ...

    def test_main_uses_specified_lang(cli_runner: CliRunner, mock_wikipedia_get_random: Mock) -> None: ...

    def test_main_returns_1_on_request_exception(cli_runner: CliRunner, mock_wikipedia_get_random: Mock) -> None: ...

    def test_main_returns_0_in_production(cli_runner: CliRunner): ...
    ```

    ```python fp=tests/conftest.py
    from _pytest.config import Config

    def pytest_configure(config: Config) -> None: ...
    ```

    </Solution>

1. Check that your docstrings are showed when you list Nox sessions using the `nox` CLI.